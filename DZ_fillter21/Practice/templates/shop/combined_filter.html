{% extends 'shop/base.html' %}

{% block title %}–§–∏–ª—å—Ç—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤{% endblock %}

{% block content %}
<h2>–§–∏–ª—å—Ç—Ä –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</h2>
<form id="filter-form" method="GET">
    <select name="category">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="electronics" {% if request.GET.category == 'electronics' %}selected{% endif %}>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
        <option value="clothing" {% if request.GET.category == 'clothing' %}selected{% endif %}>–û–¥–µ–∂–¥–∞</option>
        <option value="domestic" {% if request.GET.category == 'domestic' %}selected{% endif %}>–±—ã—Ç–æ–≤–æ–π —Ç–æ–≤–∞—Ä</option>
    </select>
    
    <input type="number" name="min_price" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" value="{{ request.GET.min_price }}">
    <input type="number" name="max_price" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" value="{{ request.GET.max_price }}">
    
    <select name="period">
        <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
        <option value="7" {% if request.GET.period == '7' %}selected{% endif %}>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</option>
        <option value="30" {% if request.GET.period == '30' %}selected{% endif %}>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
        <option value="180" {% if request.GET.period == '180' %}selected{% endif %}>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª –≥–æ–¥–∞</option>
        <option value="365" {% if request.GET.period == '365' %}selected{% endif %}>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
    </select>
    
    <select name="sort">
        <option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
        <optgroup label="–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏">
            <option value="-order_count" {% if request.GET.sort == '-order_count' %}selected{% endif %}>–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
            <option value="order_count" {% if request.GET.sort == 'order_count' %}selected{% endif %}>–ù–∞–∏–º–µ–Ω–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
        </optgroup>
        <optgroup label="–ü–æ —Ü–µ–Ω–µ">
            <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
            <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
        </optgroup>
        <optgroup label="–ü–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è">
            <option value="-id" {% if request.GET.sort == '-id' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã</option>
            <option value="id" {% if request.GET.sort == 'id' %}selected{% endif %}>–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã</option>
        </optgroup>
        <optgroup label="–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É">
            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)</option>
            <option value="-name" {% if request.GET.sort == '-name' %}selected{% endif %}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø-–ê)</option>
        </optgroup>
    </select>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div class="quick-sort-buttons" style="margin-top: 10px;">
        <button type="button" class="quick-sort-btn" data-sort="-order_count">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
        <button type="button" class="quick-sort-btn" data-sort="price">üí∞ –î–µ—à–µ–≤—ã–µ</button>
        <button type="button" class="quick-sort-btn" data-sort="-price">üíé –î–æ—Ä–æ–≥–∏–µ</button>
        <button type="button" class="quick-sort-btn" data-sort="-id">üÜï –ù–æ–≤–∏–Ω–∫–∏</button>
    </div>
    
    <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</form>

<h2>–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</h2>
<p id="product-count">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: 0</p>

<div id="loading" style="display: none;">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<div id="product-list">
    <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div id="pagination">
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ AJAX -->
</div>

<script>
// AJAX –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('filter-form').addEventListener('submit', function(event) {
    event.preventDefault();
    loadProducts(1);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
document.querySelectorAll('.quick-sort-btn').forEach(button => {
    button.addEventListener('click', function() {
        const sortValue = this.getAttribute('data-sort');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º select
        document.querySelector('select[name="sort"]').value = sortValue;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.quick-sort-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
        loadProducts(1);
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
function getPopularityLevel(orderCount) {
    if (orderCount >= 50) return 'high';
    if (orderCount >= 10) return 'medium';
    return 'low';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
function getPopularityText(orderCount) {
    if (orderCount >= 50) return '–•–ò–¢';
    if (orderCount >= 10) return '–ü–æ–ø—É–ª—è—Ä–Ω—ã–π';
    if (orderCount > 0) return '–ü–æ–∫—É–ø–∞—é—Ç';
    return '–ù–æ–≤–∏–Ω–∫–∞';
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
function loadProducts(page = 1) {
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É:', page);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('loading').style.display = 'block';
    
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    formData.set('page', page);
    
    const queryString = new URLSearchParams(formData).toString();
    console.log('Query string:', queryString);
    
    fetch(`/shop/ajax-product-list/?${queryString}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loading').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            
            if (data.products.length === 0) {
                productList.innerHTML = '<div>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            } else {
                data.products.forEach(product => {
                    const orderCount = product.order_count || 0;
                    const popularityLevel = getPopularityLevel(orderCount);
                    const popularityText = getPopularityText(orderCount);
                    
                    const productDiv = document.createElement('div');
                    productDiv.className = `product-item ${orderCount >= 10 ? 'popular' : ''}`;
                    productDiv.innerHTML = `
                        <strong>${product.name}</strong>
                        <span class="popularity-badge popularity-${popularityLevel}">${popularityText}</span>
                        <br>
                        –ó–∞–∫–∞–∑–∞–Ω: <strong>${orderCount}</strong> —Ä–∞–∑ | 
                        –¶–µ–Ω–∞: <strong>${product.price} —Ä—É–±.</strong> | 
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${product.category}
                    `;
                    productList.appendChild(productDiv);
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('product-count').textContent = `–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${data.total_count}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
            updatePagination(data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            updateActiveQuickSortButton();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-list').innerHTML = '<div>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</div>';
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function updateActiveQuickSortButton() {
    const currentSort = document.querySelector('select[name="sort"]').value;
    
    document.querySelectorAll('.quick-sort-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-sort') === currentSort) {
            btn.classList.add('active');
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function loadPage(page) {
    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:', page);
    loadProducts(page);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    let paginationHTML = '';
    
    if (data.total_pages > 1) {
        if (data.has_previous) {
            paginationHTML += `<button class="page-btn" onclick="loadPage(1)">–ü–µ—Ä–≤–∞—è</button>`;
            paginationHTML += `<button class="page-btn" onclick="loadPage(${data.previous_page})">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>`;
        }
        
        paginationHTML += `<span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.current_page} –∏–∑ ${data.total_pages}</span>`;
        
        if (data.has_next) {
            paginationHTML += `<button class="page-btn" onclick="loadPage(${data.next_page})">–°–ª–µ–¥—É—é—â–∞—è</button>`;
            paginationHTML += `<button class="page-btn" onclick="loadPage(${data.total_pages})">–ü–æ—Å–ª–µ–¥–Ω—è—è</button>`;
        }
    }
    
    pagination.innerHTML = paginationHTML;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
document.querySelectorAll('#filter-form select, #filter-form input').forEach(element => {
    element.addEventListener('change', function() {
        loadProducts(1);
        if (element.name === 'sort') {
            updateActiveQuickSortButton();
        }
    });
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = urlParams.get('page') || 1;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateActiveQuickSortButton();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    loadProducts(currentPage);
});
</script>

{% endblock %}
